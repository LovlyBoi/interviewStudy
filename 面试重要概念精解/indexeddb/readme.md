# indexeddb

随着浏览器的功能不断增强, 越来越多的网站开始考虑将大量数据存储在客户端, 这样可以减少从服务器获取数据, 直接从本地获取数据

现有的浏览器数据存储方案, 都不太适合存储大量数据: Cookie的大小不能超过4kb, 且每次请求都会发送回服务器, localStorage在2.5到10mb之间(各家浏览器不同), 且不提供搜索功能, 不能建立自定义的索引, 所以需要一种新的解决方案, 这就是indexeddb诞生的背景。

mdn官网是这样解释indexeddb的:
> indexeddb是一种底层api, 用于在客户端存储大量的结构化数据(也包括文件/二进制大型对象(blobs)), 该api使用索引实现对数据的高性能检索, 虽然web storage在存储少量的数据很有用, 但是对于存储更大量的结构化数据来说力不从心, 而indexeddb提供了这种场景的解决方案

通俗的说, indexeddb就是浏览器提供的本地数据库, 他可以被JS进行创建和操作, indexeddb允许存储大量的数据, 提供查找接口, 还能建立索引, 这些都是localStorage所不具备的, 就数据库类型而言, indexeddb不属于关系型数据库(不支持sql语句查询), 更接近nosql数据库

下表列出了几种常见的客户端存储方式的对比:

|存储类型|存储大小|失效时间|
|-|-|-|
|会话期cookie|4kb|浏览器关闭自动清除|
|持久型cookie|4kb|设置过期时间, 到期后清除|
|sessionStorage|2.5-10mb|浏览器关闭后清除|
|localStorage|2.5-10mb|永久保存, 除非手动清除|
|indexeddb|>250mb|手动更新或者删除|
|websql|已经废弃|已经废弃|

indexeddb具备以下特点:
- 键值对存储: indexeddb内部采用对象仓库(object store)存放数据, 所有类型的数据都可以直接存入, 包括js对象, 对象仓库中, 数据以键值对的形式保存, 每一个数据记录都有一个对应的主键, 主键是独一无二的, 不能有重复
- 异步: indexeddb操作时不会锁死浏览器, 用户依然可以进行其他操作, 这与localStorage形成对比, 后者的操作是同步的, 异步设计是为了防止大量数据读写, 拖慢网页的表现
- 支持事务: indexeddb支持事务(transaction), 这意味着一系列操作步骤中, 只要有一步失败, 整个事务全部取消, 数据库回滚到事务发生之前的状态, 不存在只改写一部分数据的情况, 这和mysql等数据库的事务都类似
- 同源限制: indexeddb受到同源策略的限制, 每一个数据库对应创建他的域名, 网页只能访问自身域名下的数据库, 而不能访问跨域的数据库
- 存储空间大: 这是indexeddb最显著的特点之一, indexeddb的存储空间比localStorage大的多, 一般来说不小于250mb, 甚至没有上限
- 支持二进制存储: indexeddb不仅可以存储字符串, 还可以存储二进制数据(ArrayBuffer和Blob对象)

indexeddb主要使用在客户端需要大量的数据场景下:
- 数据可视化等界面, 大量数据, 每次请求都会消耗很大性能
- 即使聊天工具, 大量消息需要存放在本地
- 其他存储方式容量不满足时, 不得已使用indexeddb

### indexeddb重要概念

- 数据库: IDBDatabase对象
- 对象仓库: IDBObjectStore对象
- 索引: IDBIndex对象
- 事务: IDBTransaction对象
- 操作请求: IDBRequest对象
- 指针: IDBCursor对象
- 主键集合: IDBKeyRange对象

下面是一些主要的概念:

1. 数据库: 数据库是一系列相关数据的容器, 每个域名（严格的说: 是域名+协议+端口）都可以新建任意多个数据库, indexeddb数据库有版本的概念, 同一个时刻, 只能有一个版本的数据库存在, 如果要修改数据库结构(新增,删除表, 索引或者主键)只能通过升级数据库版本来完成
2. 对象仓库: 每个数据库包含若干个对象仓库(object store), 他类似于关系型数据库的表格
3. 数据记录: 对象仓库保存的是数据记录, 每条记录类似于关系型数据库的行, 但是只有主键和数据体两部分, 主键用来建立默认的索引, 必须是不同的, 否则会报错
4. 索引: 为了加速数据的检索, 可以在对象仓库里面为不同的属性建立索引, 在关系型数据库中也有索引的概念, 我们可以在创建表的时候同时创建索引, 在后续对表进行查询的时候即可以通过索引来进行筛选, 给某个字段添加索引以后, 在后续插入数据额过程中, 索引字段便不能为空
5. 事务: 数据记录的读写和删改都需要通过事务来完成, 事务对象提供error, abort和complete事件, 用来监听操作结果
6. 游标: 游标类似于迭代器, 当查询到满足某一条件的所有数据时, 就需要用到游标, 我们让游标一行一行的往下走, 游标走到的地方就会返回这一行数据, 此时我们便可以对此行数据进行判断, 是否满足条件

### indexeddb实操

##### 创建以及连接数据库

```js
// 打开一个数据库(如果没有就自行创建)
function openDB(dbName, version = 1) {
    return new Promise((resolve, reject) => {
        let db;
        const request = indexedDB.open(dbName, version); // 如果没有的话就会创建
        request.onsuccess = (e) => {
            console.log("e", e);
            db = e.target.result;
            resolve(db);
        }
        request.onerror = err => {
            reject(err);
        }
        // 数据库发生更新的时候触发
        // 1. 版本号更新 2. 添加或者删除了表
        request.onupgradeneeded = (e) => {
            console.log("create e", e);
        }
    })
}
```